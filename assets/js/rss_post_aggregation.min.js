/**
 * RSS Post Aggregation - v0.1.0 - 2014-09-08 | http://webdevstudios.com | Copyright (c) 2014; | Licensed GPLv2+
 */
window.RSS_Post_Aggregation=function(e,t,i,s){"use strict";function o(){var e={},t=function(t,i,o){"boolean"==typeof i&&(o=i);var n=i?i.selector+" "+t:t;if(s===e[n]||o){var r=i?i.find(t):jQuery(t);e[n]=r}return e[n]};return t}function n(){n.history=n.history||[],n.history.push(arguments),e.console&&d.debug&&e.console.log(Array.prototype.slice.call(arguments))}var r=e.Backbone,d=e.RSSPost_l10n,c={Post:{},Posts:{},Views:{Row:{},Modal:{}},PostsView:{},$:new o,feeds:d.feeds};return c.Post=r.Model.extend({defaults:{index:0,source:"",link:"",title:"",date:"",summary:"",image:"",author:"",rss_link:""},idAttribute:"index"}),c.Posts=r.Collection.extend({model:c.Post,search:function(e){if(!e)return this;var t=RegExp(e,"gi");return _(this.filter(function(e){return t.test(e.get("title"))}))},checked:function(){var e=this.filter(function(e){return e.get("checked")===!0});return new c.Posts(e)}}),c.Views.Modal=r.View.extend({events:{"click #find-posts-submit":"submit","click #rss-save-feed":"saveFeed","keypress #rss-save-feed-input":"maybeSaveFeed","click #find-posts-close":"close","change #select-feed":"changeFeed","keyup #find-posts-input":"search"},selectorPopulated:!1,timeout:!1,feed_url:"",feed_id:"",initialize:function(){this.$feedInput=this.$("#rss-save-feed-input"),this.$feedSelector=this.$("#select-feed"),this.$response=this.$("#find-posts-response tbody"),this.$search=this.$("#find-posts-input"),this.listenTo(this,"render",this.render),this.listenTo(this,"open",this.open),this.listenTo(this,"close",this.close),this.populateFeedSelector(),this.render()},open:function(){n("app.$overlay",c.$overlay.length),c.$overlay.show(),this.$el.show()},close:function(){n("app.$overlay",c.$overlay.length),c.$overlay.hide(),this.$el.hide()},search:function(){this.waiting(),this.renderItems(this.collection.search(this.$search.val()))},saveFeed:function(){var e=this.$feedInput.val().trim();e&&(this.feed_id="",this.feed_url=e,n("saveFeed",this.feed_url),this.render())},maybeSaveFeed:function(e){13===e.which&&this.saveFeed()},changeFeed:function(){var e=this.$feedSelector.find("option:selected");this.feed_url=e.text(),this.feed_id=e.val(),n("changeFeed"),this.render()},waiting:function(){this.$response.html('<tr class="spinner-row"><td colspan="4"><div class="spinner"></div></td></tr>'),this.$response.find(".spinner").show()},timeLimit:function(t){var i=this;this.timeout=e.setTimeout(function(){i.nope()},t)},nope:function(){this.$response.html('<tr class="spinner-row error"><td colspan="4"><p>'+d.no_data+"</p></td></tr>")},render:function(){return this.waiting(),this.fetchAndPopulate(),this},populateFeedSelector:function(){if(!c.feeds)return this.timeLimit(1e3);var e="",t="",i="";_.each(c.feeds,function(s,o){t=t?t:s,i=i?i:o,e+='<option value="'+o+'">'+s+"</option>"}),this.$feedSelector.html(e),this.selectorPopulated=!0,this.feed_id=i,this.feed_url=t},maybeAppendSelector:function(e,t){return this.selectorPopulated||this.populateFeedSelector(),!this.selectorPopulated||this.$feedSelector.find('option[value="'+t+'"]').length?(n("feed exists"),s):(this.feed_id=t,c.feeds[t]=e,n("append feed",c.feeds),this.$feedSelector.append('<option value="'+t+'" selected="selected">'+e+"</option>"),s)},fetchAndPopulate:function(){if(!this.feed_url)return this.timeLimit(1e3);n("this.feed_url",this.feed_url),this.timeLimit(4e3);var t=this;i.ajax({type:"post",dataType:"json",url:ajaxurl,data:{action:"rss_get_data",feed_url:this.feed_url,feed_id:this.feed_id},success:function(i){i.success?(e.clearTimeout(t.timeout),t.populateItems(i.data.feed_items),t.maybeAppendSelector(i.data.feed_url,i.data.feed_id)):n("response",i)}})},populateItems:function(e){this.collection=new c.Posts(_.toArray(e)),n("this.collection",this.collection),this.renderItems()},submit:function(t){t.preventDefault();var i=this.collection.checked();return i?(n("checked",i),n(i?i.toJSON():"nothing checked"),this.importPosts(i.toJSON()),s):(e.confirm(d.nothing_checked)&&this.close(),s)},importPosts:function(t){this.$(".find-box-buttons .spinner").show();var s={action:"rss_save_posts",to_add:t,feed_url:this.feed_url,feed_id:this.feed_id};n("data",s),i.ajax({type:"post",dataType:"json",url:ajaxurl,data:s,success:function(t){n("response",t),t.success?e.location.href=d.cpt_url:n("response",t)}})},renderItems:function(e){e=e?e:this.collection;var i=t.createDocumentFragment();e.each(function(e){var t=new c.Views.Row({model:e});i.appendChild(t.render().el)}),this.timeout=!1,this.$response.html(i)}}),c.Views.Row=r.View.extend({tagName:"tr",template:wp.template("rssitem"),checked:{},events:{click:"clickRow"},id:function(){return"rss-item-"+this.model.get("index")},className:function(){return"found-posts "+(0===this.model.get("index")%2?"":"alternate")},attributes:function(){return{title:this.model.get("url"),"data-img":this.model.get("img")}},clickRow:function(e){var t,s=this.$(".found-radio input").prop("checked"),o=i(e.target),n=o.is("input")||o.is("label");n?(t=o.val(),s?this.model.set("checked",!0):this.model.set("checked",!1)):s?(t=this.$(".found-radio input").prop("checked",!1).val(),this.model.set("checked",!1)):(t=this.$(".found-radio input").prop("checked",!0).val(),this.model.set("checked",!0))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),c.openModal=function(e){e.preventDefault(),c.PostsView.trigger("open")},c.closeModal=function(e){e.preventDefault(),c.PostsView.trigger("close")},c.init=function(){n(c),c.$('.add-new-h2, [href="post-new.php?post_type='+d.cpt+'"]').on("click",c.openModal),n("l10n",d);var e=_.toArray(d.feeds);e=e.length?e.length:{},c.$overlay=c.$(".ui-find-overlay",c.$("body")).on("click",c.closeModal),c.$("body").on("keyup",function(e){27===e.which&&c.PostsView.trigger("close")}),c.PostsView=new c.Views.Modal({el:"#find-posts"}),d.show_modal&&c.PostsView.trigger("open")},i(t).ready(c.init),c}(window,document,jQuery);